
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jira-graph-viz</title>
    <script type="text/javascript" src="{{ url_for('static', filename= 'd3.min.js' )}}"></script>
    <style type="text/css">
        div.tooltip {
            position: absolute;
            text-align: left;
            width: 400px;
            padding: 4px;
            font: 20px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

        .bar { fill: steelblue; }
    </style>
</head>
<body>
<h2>Sherpath assignments by month</h2>
<h3 id="month"></h3>
<script>



    // set the dimensions and margins of the graph
    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    // set the ranges
    var x = d3.scaleBand()
        .range([0, width])
        .padding(0.1);
    var y = d3.scaleLinear()
        .range([height, 0]);

    // append the svg object to the body of the page
    // append a 'group' element to 'svg'
    // moves the 'group' element to the top left margin
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    let data = d3.csvParse({{query | tojson}});

    let monthNum = 0;

    let transformedData = [];


    function updateData(monthNum) {
        let transformedData = [];
        transformedData.push({ "assignment_type": "lesson", "number": data[monthNum]["lessons_assigned"]});
        transformedData.push({ "assignment_type": "non adaptive quiz", "number": data[monthNum]["non_adaptive_quizzes_assigned"]});
        transformedData.push({ "assignment_type": "skill", "number": data[monthNum]["skills_assigned"]});
        transformedData.push({ "assignment_type": "simulation", "number": data[monthNum]["simulations_assigned"]});
        x.domain(transformedData.map(function(d) {return d.assignment_type}));
        y.domain([0,d3.max(data, function(d) { return Math.max(d["lessons_assigned"],d["non_adaptive_quizzes_assigned"],d["skills_assigned"],d["simulations_assigned"])})]);

        svg.select(".x-axis")
            .remove();
        svg.select(".y-axis")
            .remove();
        // add the x Axis
        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        // add the y Axis
        svg.append("g")
            .attr("class","y-axis")
            .call(d3.axisLeft(y));

        document.getElementById("month").innerText = data[monthNum]["assignable_month"];
        return transformedData;
    }

    transformedData = updateData(monthNum);


    // append the rectangles for the bar chart

    function updateViz() {
        var updateSelection = svg.selectAll(".bar")
            .data(transformedData);


            updateSelection.enter()
                .append("rect")
                .merge(updateSelection)
                .attr("class", "bar")
                .attr("x", function (d) {
                    return x(d.assignment_type)
                })
                .attr("width", x.bandwidth())
                .attr("y", function (d) {
                    return y(0);
                })
                .attr("height", 0)
                .transition()
                .attr("y", function (d) {
                    return y(d.number)
                })
                .duration(2000)
                .attr("height", function (d) {
                    return height - y(d.number)
                })
    }

    updateViz();



    d3.selectAll('rect')
        .on("click", function(d,i) {
        if (monthNum < 5){
            monthNum = monthNum + 1;
        } else { monthNum = 0 }
        transformedData = updateData(monthNum);
        console.log(transformedData)
        updateViz();
    })
</script>



</body>
</html>